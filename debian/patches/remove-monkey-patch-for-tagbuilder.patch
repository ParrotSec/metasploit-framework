From: Daniel Ruiz de Alegr√≠a <daniruiz@kali.org>
Date: Wed, 01 Oct 2025 16:52:10 +0200
Subject: Drop patch "Add the monkey patch for the TagBuilder that pro needs"


The introduction of this patch breaks metasploit in Kali

https://github.com/rapid7/metasploit-framework/commit/672e9fb32e14667abff8d15c4409991cf4e9421a
https://github.com/rapid7/metasploit-framework/pull/20499


/tmp/metasploit-framework/debian/metasploit-framework/usr/share/metasploit-framework/config/application.rb:10:in `<top (required)>': unhandled exception
        from /usr/lib/ruby/3.3.0/bundled_gems.rb:69:in `require'
        from /usr/lib/ruby/3.3.0/bundled_gems.rb:69:in `block (2 levels) in replace_require'
        from /tmp/metasploit-framework/debian/metasploit-framework/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/bootsnap-1.18.6/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'
        from /tmp/metasploit-framework/debian/metasploit-framework/usr/share/metasploit-framework/config/environment.rb:2:in `<top (required)>'
        from /usr/lib/ruby/3.3.0/bundled_gems.rb:69:in `require'
        from /usr/lib/ruby/3.3.0/bundled_gems.rb:69:in `block (2 levels) in replace_require'
        from /tmp/metasploit-framework/debian/metasploit-framework/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/bootsnap-1.18.6/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'
        from /tmp/metasploit-framework/debian/metasploit-framework/usr/share/metasploit-framework/lib/msfenv.rb:28:in `<top (required)>'
        from <internal:/usr/lib/ruby/vendor_ruby/rubygems/core_ext/kernel_require.rb>:136:in `require'
        from <internal:/usr/lib/ruby/vendor_ruby/rubygems/core_ext/kernel_require.rb>:136:in `require'
        from debian/generate-msfvenom-bash-completion.rb:3:in `<main>'


---
--- a/config/application.rb
+++ b/config/application.rb
@@ -4,25 +4,6 @@
 require 'rails'
 require File.expand_path('../boot', __FILE__)
 
-require 'action_view'
-# Monkey patch https://github.com/rails/rails/blob/v7.2.2.1/actionview/lib/action_view/helpers/tag_helper.rb#L51
-# Might be fixed by 8.x https://github.com/rails/rails/blob/v8.0.2/actionview/lib/action_view/helpers/tag_helper.rb#L51C1-L52C1
-raise unless ActionView::VERSION::STRING == '7.2.2.2' # A developer will need to ensure this is still required when bumping rails
-module ActionView::Helpers::TagHelper
-  class TagBuilder
-    def self.define_element(name, code_generator:, method_name: name.to_s.underscore)
-      code_generator.define_cached_method(method_name, namespace: :tag_builder) do |batch|
-        # Fixing a bug introduced by Metasploit's global Kernel patch: https://github.com/rapid7/metasploit-framework/blob/ae1db09f32cd04c007dbf445cf16dc22c9fc2e53/lib/rex.rb#L74-L79
-        # which fails when using the below 'instance_methods.include?(method_name.to_sym)' check
-        batch.push(<<~RUBY) # unless instance_methods.include?(method_name.to_sym)
-              def #{method_name}(content = nil, escape: true, **options, &block)
-                tag_string("#{name}", content, options, escape: escape, &block)
-              end
-            RUBY
-      end
-    end
-  end
-end
 
 all_environments = [
     :development,
